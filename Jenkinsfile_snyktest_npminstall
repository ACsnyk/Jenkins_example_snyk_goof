pipeline{
    agent any

    tools {nodejs "Nodejs14"}

   stages{
    stage('Initialize & Cleanup Workspace') {
        steps{
       println 'Initialize & Cleanup Workspace'
            cleanWs()
        }
    }

    stage('Git Clone') {
        steps{
        git url: 'https://github.com/ACsnyk/snyk-goof.git'
            sh 'ls -la'
            sh  "npm install"
        }
    }

    stage('Test Build Requirements') {
        steps{
        sh 'npm -v'
        sh 'node -v'
        }
    }

    // Not required if you install the Snyk CLI on your Agent
    stage('Npm install Snyk CLI') {
        steps{
            script{
            sh 'npm install -g snyk'
            sh 'npm install snyk-to-html -g'
            }
        }
    }

    // Authorize the Snyk CLI
        stage('Authorize Snyk CLI') {
            steps{
            withCredentials([string(credentialsId: 'Alex_snyk_token', variable: 'SNYK_TOKEN_VAR')]) {    
            sh 'snyk auth ${SNYK_TOKEN_VAR}'
        }
    }
    }

    // Run snyk test to check for vulnerabilities and fail the build if any are found
    // Consider using --severity-threshold=<low|medium|high> for more granularity (see snyk help for more info).
    stage('Snyk Tests & Monitor') {
        steps{
            script{
        try{
            sh 'snyk test --json | snyk-to-html -o result.html'
        }
        catch (exception){
        println "[WARN] Snyk test command failed due to:\n${exception}"
        println " Testing Snyk code"
        sh 'snyk code test --json | snyk-to-html -o result-code.html'
    
    }
}
}
    }
   }

    post{
        always{
            archiveArtifacts:"result*html"
        }
    }
}
